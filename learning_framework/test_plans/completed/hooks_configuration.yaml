# ABOUTME: Test plan for validating hooks configuration in the dev harness
# ABOUTME: Addresses the discovered issue: hooks exist but aren't wired up

feature:
  name: hooks_configuration
  description: Validate that settings.json hooks configuration enables expected behavior
  category: claude-code

# Context: Why this test plan exists
discovered_issue:
  date: 2025-12-01
  problem: |
    Hooks scripts exist in .claude/hooks/ but aren't firing because
    there's no .claude/settings.json to configure them.
    Only .claude/settings.local.json exists (with permissions only).

  symptoms:
    - Time tracking not happening automatically
    - Git commits not being prompted after tests pass
    - Dangerous git commands not being blocked
    - Session start time not being recorded

  hypothesis: |
    Creating .claude/settings.json with proper hooks configuration
    will enable all the enforcement behavior.

# What we need to validate before implementing
validation_goals:
  - Confirm hooks fire when configured in settings.json
  - Confirm hooks receive expected input format
  - Confirm hooks can block/allow as designed
  - Confirm multiple hooks can coexist
  - Confirm time tracking hooks work with git hooks

# Proposed settings.json configuration to test
proposed_configuration:
  file: .claude/settings.json
  content: |
    {
      "hooks": {
        "PreToolUse": [
          {
            "matcher": "Bash|Write|Edit",
            "hooks": [{
              "type": "command",
              "command": "$CLAUDE_PROJECT_DIR/.claude/hooks/validate-git-command.py"
            }]
          }
        ],
        "PostToolUse": [
          {
            "matcher": "Bash",
            "hooks": [{
              "type": "command",
              "command": "$CLAUDE_PROJECT_DIR/.claude/hooks/post-test-commit-check.py"
            }]
          }
        ],
        "SubagentStop": [
          {
            "hooks": [{
              "type": "command",
              "command": "$CLAUDE_PROJECT_DIR/.claude/hooks/verify-git-subagent.py"
            }]
          }
        ],
        "Stop": [
          {
            "hooks": [
              {
                "type": "command",
                "command": "$CLAUDE_PROJECT_DIR/.claude/hooks/final-commit-check.py"
              },
              {
                "type": "command",
                "command": "$CLAUDE_PROJECT_DIR/.claude/hooks/track-session-time.py"
              }
            ]
          }
        ],
        "UserPromptSubmit": [
          {
            "hooks": [{
              "type": "command",
              "command": "$CLAUDE_PROJECT_DIR/.claude/hooks/session-start-tracking.py"
            }]
          }
        ]
      }
    }

hypotheses:
  - id: h1
    statement: "PreToolUse hooks fire before Bash commands execute"
    test: Try a dangerous git command, verify it's blocked

  - id: h2
    statement: "PostToolUse hooks fire after Bash commands complete"
    test: Run a test command, verify commit prompt appears

  - id: h3
    statement: "Stop hooks fire when session ends"
    test: End session with uncommitted changes, verify prompt

  - id: h4
    statement: "UserPromptSubmit hooks fire on each prompt"
    test: Check if session start time file is created

  - id: h5
    statement: "Multiple hooks of same type can coexist"
    test: Verify both final-commit-check and track-session-time fire on Stop

  - id: h6
    statement: "$CLAUDE_PROJECT_DIR variable resolves correctly"
    test: Verify hooks find their scripts regardless of cwd

experiments:
  - id: test_pretooluse_blocking
    hypothesis_id: h1
    description: Verify dangerous commands are blocked
    setup:
      - Create settings.json with PreToolUse hook
      - Restart Claude to load new settings
    test_steps:
      - Ask Claude to run "git reset --hard"
      - Observe if hook blocks the command
    expected:
      - Hook fires before command executes
      - Command is blocked with explanatory message
      - Claude sees the block message

  - id: test_posttooluse_prompt
    hypothesis_id: h2
    description: Verify commit prompt after tests pass
    setup:
      - Create settings.json with PostToolUse hook
      - Have some uncommitted changes
    test_steps:
      - Run "pytest" or similar test command
      - Observe hook output
    expected:
      - Hook fires after test completes
      - If tests pass AND uncommitted changes exist, prompts for commit

  - id: test_session_start_tracking
    hypothesis_id: h4
    description: Verify session start time is recorded
    setup:
      - Create settings.json with UserPromptSubmit hook
      - Note current session ID
    test_steps:
      - Send any prompt
      - Check /tmp/claude_session_start_{session_id}
    expected:
      - File exists with ISO timestamp
      - Timestamp is approximately "now"

  - id: test_stop_hooks
    hypothesis_id: h3
    description: Verify Stop hooks fire on session end
    setup:
      - Create settings.json with Stop hooks
      - Have uncommitted changes
    test_steps:
      - Try to end session (say "goodbye" or similar)
      - Observe if hook blocks
    expected:
      - final-commit-check fires and blocks
      - Message prompts for commit

  - id: test_hook_coexistence
    hypothesis_id: h5
    description: Verify multiple Stop hooks both fire
    setup:
      - Configure both final-commit-check and track-session-time on Stop
    test_steps:
      - End session cleanly (no uncommitted changes)
      - Check if time tracking file was created
    expected:
      - Both hooks execute
      - Time log entry created in outputs/time_logs/

  - id: test_project_dir_variable
    hypothesis_id: h6
    description: Verify $CLAUDE_PROJECT_DIR resolves correctly
    setup:
      - Configure hooks using $CLAUDE_PROJECT_DIR
      - cd to a subdirectory
    test_steps:
      - Run a command that triggers a hook
      - Verify hook script is found and executes
    expected:
      - Hook works regardless of current working directory

# Manual testing process (before SDK automation)
testing_process:
  phase_1_manual_validation:
    description: Test hooks manually before full configuration
    steps:
      - step: Test hook scripts directly
        commands:
          - |
            # Test validate-git-command.py
            echo '{"tool_name": "Bash", "tool_input": {"command": "git reset --hard"}}' | \
              .claude/hooks/validate-git-command.py
            echo "Exit code: $?"
          - |
            # Test session-start-tracking.py
            echo '{"session_id": "test123"}' | \
              .claude/hooks/session-start-tracking.py
            cat /tmp/claude_session_start_test123
        expected:
          - validate-git-command.py exits with code 2 and shows block message
          - session-start-tracking.py creates timestamp file

  phase_2_incremental_config:
    description: Add hooks one at a time to isolate issues
    steps:
      - step: Start with just PreToolUse
        config: |
          {
            "hooks": {
              "PreToolUse": [
                {
                  "matcher": "Bash",
                  "hooks": [{
                    "type": "command",
                    "command": "$CLAUDE_PROJECT_DIR/.claude/hooks/validate-git-command.py"
                  }]
                }
              ]
            }
          }
        test: Try "git reset --hard", verify blocked

      - step: Add PostToolUse
        test: Run tests with uncommitted changes, verify prompt

      - step: Add UserPromptSubmit
        test: Check session start file created

      - step: Add Stop hooks
        test: End session, verify both hooks fire

  phase_3_full_integration:
    description: Test complete configuration
    steps:
      - Create full settings.json with all hooks
      - Run through complete workflow
      - Verify all hooks work together

success_criteria:
  - All 6 hypotheses validated
  - No conflicts between hooks
  - Time tracking works end-to-end
  - Git safety enforcement works
  - Configuration is documented and repeatable

potential_issues:
  - "$CLAUDE_PROJECT_DIR might not be set in all contexts"
  - "Hook order within same event might matter"
  - "settings.json vs settings.local.json precedence unclear"
  - "Hooks might not fire in Agent SDK context (our test runner)"

already_validated:
  date: 2025-12-01
  tests:
    - name: validate-git-command.py script works
      command: |
        echo '{"tool_name": "Bash", "tool_input": {"command": "git reset --hard"}}' | \
          python .claude/hooks/validate-git-command.py
      result: "Exit code 2, shows block message correctly"

    - name: session-start-tracking.py script works
      command: |
        echo '{"session_id": "test123"}' | \
          python .claude/hooks/session-start-tracking.py
      result: "Creates /tmp/claude_session_start_test123 with ISO timestamp"

  conclusion: |
    Hook scripts work correctly in isolation.
    The issue is purely configuration - settings.json doesn't exist.

next_step: |
  Create .claude/settings.json with the proposed configuration,
  restart Claude Code, and test incrementally per phase_2.

notes: |
  This test plan should be run MANUALLY first (not via run_experiment.py)
  because:
  1. We need to test hooks in actual Claude Code context
  2. Agent SDK spawned instances may have different hook loading
  3. Need to observe session lifecycle events (Stop, etc.)

  After manual validation, we can document findings in LEARNINGS.md
  and potentially create automated tests for regression.
