# ABOUTME: Test plan for validating claude-code-logger proxy as a debugging tool
# ABOUTME: Determines if proxy can capture hook outputs and full context for experiments

feature:
  name: claude_code_logger_proxy
  description: Can claude-code-logger proxy show hook outputs and full Claude context?
  category: debugging

core_hypothesis: |
  The claude-code-logger proxy can intercept API traffic from the Agent SDK,
  showing the full system prompt including hook outputs that aren't visible
  in the SDK's message stream.

hypotheses:
  - id: h1
    statement: "claude-code-logger captures full system prompt with hook outputs"
    evidence_needed:
      - Proxy shows system prompt content
      - Hook stdout appears in the logged request
      - Can distinguish between different hook outputs
    manual_test: true  # Requires two terminals

  - id: h2
    statement: "Agent SDK can route through proxy via ANTHROPIC_BASE_URL env var"
    evidence_needed:
      - Setting env={'ANTHROPIC_BASE_URL': 'http://localhost:8000'} works
      - SDK successfully communicates through proxy
      - No SSL/certificate errors

  - id: h3
    statement: "Proxy output is useful for debugging skill enforcement"
    evidence_needed:
      - Can see when PreToolUse hook fires
      - Can see the skill enforcement message in context
      - Timing/ordering of hook execution is visible

experiments:
  - id: basic_proxy_test
    hypothesis_id: h1
    description: Verify proxy captures hook output
    manual_steps:
      - step: 1
        action: "Start proxy in Terminal 1"
        command: "npx claude-code-logger start --verbose --log-body"
        expect: "Proxy starts on port 8000"

      - step: 2
        action: "Run test script in Terminal 2"
        command: |
          cd learning_framework
          python3 test_with_proxy.py "Write a simple test at tests/test_hello.py"
        expect: "Agent SDK connects through proxy"

      - step: 3
        action: "Check proxy output in Terminal 1"
        observe:
          - "Look for 'system' message in logged request"
          - "Search for hook output text (e.g., 'TEST FILE DETECTED')"
          - "Note if full prompt is visible or truncated"

    success_criteria:
      - "Proxy shows incoming request to /v1/messages"
      - "System prompt content is visible in --verbose mode"
      - "Hook output text appears in the system prompt"

  - id: sdk_env_routing
    hypothesis_id: h2
    description: Verify SDK respects ANTHROPIC_BASE_URL
    setup:
      script: learning_framework/test_with_proxy.py
      env_var: ANTHROPIC_BASE_URL=http://localhost:8000
    manual_steps:
      - step: 1
        action: "Start proxy"
        command: "npx claude-code-logger start --verbose"

      - step: 2
        action: "Run SDK with env override"
        command: "python3 test_with_proxy.py 'Hello'"

      - step: 3
        action: "Verify proxy received request"
        observe: "Check Terminal 1 for API request"

    success_criteria:
      - "Request appears in proxy log"
      - "No connection errors in SDK output"

  - id: pretooluse_hook_visibility
    hypothesis_id: h3
    description: See PreToolUse hook output for file enforcement
    setup:
      hook: tester_workspace/.claude/hooks/enforce-file-skills.py
      settings: tester_workspace/.claude/settings.json (with PreToolUse matcher)
    manual_steps:
      - step: 1
        action: "Ensure hook is configured in tester_workspace"
        verify: "cat tester_workspace/.claude/settings.json shows PreToolUse hook"

      - step: 2
        action: "Start proxy"
        command: "npx claude-code-logger start --verbose --log-body"

      - step: 3
        action: "Trigger file edit that should fire hook"
        command: |
          python3 test_with_proxy.py "Create a test file at tests/test_math.py with a simple addition test"

      - step: 4
        action: "Search proxy output for hook message"
        observe:
          - "Look for 'FILE-BASED SKILL ENFORCEMENT' text"
          - "Look for 'testing-anti-patterns' skill mention"
          - "Note where in the request this appears"

    success_criteria:
      - "Hook output visible in proxy log"
      - "Can identify which tool use triggered the hook"
      - "Output appears before the tool execution (PreToolUse)"

recording_template: |
  After running experiments, record results:

  ```bash
  cd learning_framework && python3 record_experiment.py \
      --feature claude_code_logger_proxy \
      --hypothesis "HYPOTHESIS_TEXT" \
      --prompt "Manual test: DESCRIPTION" \
      --expected invoked \
      --actual invoked|not_invoked \
      --notes "OBSERVATIONS"
  ```

artifacts:
  - path: learning_framework/test_with_proxy.py
    description: Test script that routes SDK through proxy
  - path: tester_workspace/.claude/hooks/enforce-file-skills.py
    description: PreToolUse hook for file-based skill enforcement

notes: |
  This test plan requires manual execution in two terminals.
  The proxy must be running before the SDK test is executed.

  Key things to look for in proxy output:
  1. The "messages" array in the API request
  2. System message content (often first in array)
  3. Any text that matches hook print() statements

  If hook output is NOT visible, it may mean:
  - Hooks output to stderr not stdout
  - Hook output is processed differently by Claude Code
  - Output is injected at a different layer than API calls
